# Микроконтроллеры мехатронных систем
### Курсовая работа по теме "Двухтональный звуковой излучатель"
Выполнили ст. гр. 233
Будылин М.А.,
Зенкин В.С.


### Описание устройства
Данное устройство способно отдельно генерировать две различные настраиваемые частоты, а также имеет режим сирены, в котором оно воспроизводит сигнал с частотой плавно меняющейся от меньшей частоты к большей и обратно, с периодом настроенным пользователем.

Устройство состоит из платы микроконтроллера Arduino UNO R3, LCD дисплея 20*4 I2C для вывода пользовательского интерфейса, энкодера с кнопкой для регулирования значений частоты и периода, а также включения и выключения режима регулирования парамметров, тактовой кнопки для переключения между сигналами, пьезоизлучателя (динамика) для воспроизведения выбранного сигнала, потенциометра в связке с транзистором в качестве усилителя и различных номиналов резисторов.

Структурная схема устройства:
![image](https://github.com/user-attachments/assets/d60e2d83-8fbd-4618-b6fc-2780fe70b542)


### Используемые библиотеки
1.	Tone – библиотека для генерации прямоугольных сигналов на произвольном выводе. Используется для генерации сигнала на пьезоизлучателе. Источник: https://github.com/bhagman/Tone
2.	LiquidCrystal_I2C – библиотека для управления дисплеями I2C. Используется для вывода информации на дисплей. Источник: https://github.com/mrkaleArduinoLib/LiquidCrystal_I2C/tree/master

### Программная часть устрйоства

Имеется основная переменная switch_mode принимающая значение от 0 до 2, которая определяет какой из параметров выбран пользователем:
0 – Первая граничная частота
1 – Вторая граничная частота
2 – Режим сирены

Изменение этой переменной осуществляется по нажатию кнопки.
Описание процесса изменения переменной switch_mode:
Нажатие кнопки изменяет напряжение на выводе микроконтроллера, что в свою очередь вызывает прерывание и немедленно начинается выполнение функции switch_func, которая отвечает за изменение переменной switch_mode.
Код функции switch_func:
```
void switch_func(){ // Немедленно выполняется при нажатии кнопки переключения сигнала
  if (millis() - debounce >= 250) {  // Защита от дребезга контактов
    debounce = millis();
    switch_mode += 1;
    if (switch_mode == 3){
      switch_mode = 0;
    }
    cursor_switch = true;
    siren_config = true;
    }
}
```

За режим регулирования отвечает переменная adj_flag, принимающая значения true – режим регулирования включён или false – режим регулирования выключен. Её значение изменяется по нажатию на кнопку энкодера с вызовом прерывания и соответствующей функции adj_func:
```
void adj_func(){ // Немедленно выполняется при нажатии кнопки энкодера
  if (millis() - debounce >= 250) {  // Защита от дребезга контактов
    debounce = millis();
    adj_flag = !adj_flag;
    adj_print = true; 
    }
}
```
Код основного цикла программы:

```
void loop(){

  print_adj();  // Вывод "ADJ" если активирован режим настройки, либо стирание "ADJ"

  cursor(); // Вывод курсора

  if (adj_flag){  // Работа в режиме регулировки частоты и времени
    adjustment();
  } 

  play_mode_tone();  // Функция воспроизведения выбранного сигнала
  }

```

Код основного цикла программы включает в себя:

•	Функции print_adj() и cursor() отвечают за вывод графических элементов интерфейса, которые изменяются в ходе работы устройства;
•	Функция adjustment(), выполняющаяся при активном режиме регулирования, считывает поворот энкодера с помощью функции encoder() и изменяет значение параметра, определяемого переменной switch_mode;
Код функции adjustment():
```
void adjustment(){ // Функция регулировки частоты

  encoder(); // Считываем вращение энкодера
  
  if (enc_val != 0){ // Проверка на поворот энкодера
    acceleration_enc();
    if (switch_mode == 0){    // Выбрана 1 граничная частота
      Freq1 = check_freq_range(Freq1 + enc_val*acceleration_coef);  // Проверка значения частоты на превышение заданных границ  
      print_value(3, 1, Freq1);
      }

    else if (switch_mode == 1){   // Выбрана вторая граничная частота
      Freq2 = check_freq_range(Freq2 + enc_val*acceleration_coef); // Проверка значения частоты на превышение заданных границ 
      print_value(3, 2, Freq2);
      }
    else{             // Выбран режим сирены с настройкой периода сирены
      siren_duration = check_time(siren_duration+enc_val*100*acceleration_coef); // Проверка значения периода на корректность 
      siren_config = true;    // Флаг активирует перезапуск сирены с изменением её конфигурации

      // Вывод периода в секундах. Например 1100 мс переводит в 1.1 сек.
      print_value(10, 3, siren_duration / 1000);
      lcd.setCursor(14,3);
      lcd.print(".");
      lcd.setCursor(15,3);
      lcd.print((siren_duration-(siren_duration/1000)*1000)/100);
    }
    }
  }
```
Код функции encoder():
```
byte prevState; // Предыдущие значения на выводах энкодера
// Переменные для значений на выводах энкодера
bool encA;
bool encB;

void encoder(){ // Программа для считывания вращения энкодера
  enc_val = 0;
  encA = digitalRead(encPinA);
  encB = digitalRead(encPinB);
  if ((encA) && (encB)){
    if (prevState==B00000001){
      enc_val = -1;
    }
    else if (prevState==B00000010){
      enc_val = 1;
    }
    prevState=B00000011;
  }
  else if ((!encA) && (encB)){
    if (prevState==B00000000){
      enc_val = -1;
    }
    else if (prevState==B00000011){
      enc_val = 1;
    }
    prevState=B00000001;
  }
  else if ((encA) && (!encB)){
    if (prevState==B00000011){
      enc_val = -1;
    }
    else if (prevState==B00000000){
      enc_val = 1;
    }
    prevState=B00000010;
  }  
}
```
•	Функция play_mode_tone() выполняется всегда и генерирует сигнал выбранный пользователем, определяемый переменной switch_mode.
Код функции play_mode_tone():
```
void play_mode_tone(){  // Функция, которая активирует воспроизведение сигнала в выбранном режиме
  if (switch_mode == 0){    // 1 граничная частота
    speaker.play(Freq1);
    }

  else if (switch_mode == 1){  // 2 граничная частота
    speaker.play(Freq2);
    }
  else{         // Режим сирены
    siren_mode();
  }}
```
Основным объектом программы является объект speaker класса Tone. Его основные функции:
-	begin() – назначает вывод, на который будет воспроизводиться сигнал;
-	play() – воспроизводит сигнал с заданной частотой;
-	stop() – останавливает воспроизведение сигнала.

